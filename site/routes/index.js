"use strict";

var express = require('express');
var router = express.Router();
let db = require('sqlite');

const dbPromise = Promise.resolve()
	.then(() => db.open('./database.db', { Promise }))
	.then(db => db.migrate({ force: 'last' }));

/* GET home page. */
router.get('/', function(req, res, next) {
  res.render('index', { title: 'Express2', items: posts });
});


router.get('/api/posts/:id', function(req, res, next) {
	res.setHeader('Content-Type', 'application/json');

	let itemId = req.params.id;
	console.log(itemId);

	dbPromise.then((db) => {
		db.get(`SELECT * FROM Post JOIN User ON Post.userId=User.id WHERE Post.id='${itemId}' LIMIT 1`).then(post => {
			res.send(post);
		});
	});
});

router.get('/login', function(req, res, next) {
  res.render('login', { title: 'Login' });
});

router.get('/api/posts', function(req, res, next) {
  res.setHeader('Content-Type', 'application/json');

	dbPromise.then((db) => {
		db.all('SELECT * FROM Post INNER JOIN User ON Post.userId=User.id LIMIT 10').then(posts => {
			res.send(posts);
		});
	});

});

// this is the keys required by the client - autogenerated from .env file (is this a good idea?)
router.get('/javascripts/keys.js', function(req, res, next) {
    res.setHeader('Content-Type', 'text/javascript');

    var script = "var GOOGLE_CLIENT_ID = \"" + process.env.GOOGLE_CLIENT_ID + "\";";

    res.send(script);
});

module.exports = router;
